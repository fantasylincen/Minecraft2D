<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft2D 地形生成测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .canvas-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        canvas {
            border: 1px solid #ddd;
            background: #87CEEB;
        }
        .stats {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .stat-item {
            padding: 8px;
            background: white;
            border-radius: 4px;
            text-align: center;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Minecraft2D 地形生成测试</h1>
        
        <div class="test-section">
            <h2>测试控制</h2>
            <button onclick="runTerrainTest()">运行地形测试</button>
            <button onclick="generateVisualTest()">生成可视化测试</button>
            <button onclick="clearLog()">清空日志</button>
        </div>
        
        <div class="test-section">
            <h2>测试日志</h2>
            <div id="log" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>可视化测试</h2>
            <div class="canvas-container">
                <canvas id="terrainCanvas" width="800" height="400"></canvas>
            </div>
        </div>
        
        <div class="test-section">
            <h2>统计信息</h2>
            <div id="stats" class="stats">
                <div class="stats-grid" id="statsGrid">
                    <!-- 统计信息将在这里显示 -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 导入必要的模块
        import { WorldGenerator } from './minecraft2d-game/src/world/WorldGenerator.js';
        import { blockConfig } from './minecraft2d-game/src/config/BlockConfig.js';
        
        // 全局变量
        let worldGenerator = null;
        let testResults = {};
        
        // 日志函数
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        // 清空日志
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // 更新统计信息
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            // 基本统计
            const basicStats = [
                { label: '生成器状态', value: worldGenerator ? '已初始化' : '未初始化' },
                { label: '测试运行时间', value: testResults.testTime ? `${testResults.testTime.toFixed(2)}ms` : 'N/A' },
                { label: '区块生成数量', value: testResults.chunkCount || 0 },
                { label: '平均生成时间', value: testResults.avgGenerationTime ? `${testResults.avgGenerationTime.toFixed(2)}ms` : 'N/A' }
            ];
            
            // 地形统计
            if (testResults.terrainStats) {
                basicStats.push(
                    { label: '最小高度', value: testResults.terrainStats.minHeight || 'N/A' },
                    { label: '最大高度', value: testResults.terrainStats.maxHeight || 'N/A' },
                    { label: '平均高度', value: testResults.terrainStats.avgHeight ? testResults.terrainStats.avgHeight.toFixed(1) : 'N/A' },
                    { label: '高度范围', value: testResults.terrainStats.heightRange || 'N/A' }
                );
            }
            
            // 方块统计
            if (testResults.blockStats) {
                basicStats.push(
                    { label: '总方块数', value: testResults.blockStats.totalBlocks || 0 },
                    { label: '方块类型数', value: testResults.blockStats.blockTypes || 0 },
                    { label: '最常见方块', value: testResults.blockStats.mostCommonBlock || 'N/A' }
                );
            }
            
            // 生物群系统计
            if (testResults.biomeStats) {
                basicStats.push(
                    { label: '生物群系数', value: testResults.biomeStats.biomeCount || 0 },
                    { label: '最常见生物群系', value: testResults.biomeStats.mostCommonBiome || 'N/A' }
                );
            }
            
            // 植被统计
            if (testResults.vegetationStats) {
                basicStats.push(
                    { label: '植被总数', value: testResults.vegetationStats.total || 0 },
                    { label: '植被覆盖率', value: testResults.vegetationStats.coverage ? `${testResults.vegetationStats.coverage.toFixed(2)}%` : 'N/A' }
                );
            }
            
            // 渲染统计
            basicStats.forEach(stat => {
                const statElement = document.createElement('div');
                statElement.className = 'stat-item';
                statElement.innerHTML = `<strong>${stat.label}:</strong><br>${stat.value}`;
                statsGrid.appendChild(statElement);
            });
        }
        
        // 运行地形测试
        async function runTerrainTest() {
            log('开始地形生成测试...');
            
            try {
                const startTime = performance.now();
                
                // 创建世界生成器
                worldGenerator = new WorldGenerator(12345);
                
                // 模拟世界配置
                const worldConfig = {
                    CHUNK_SIZE: 64,
                    WORLD_HEIGHT: 400,
                    BLOCK_SIZE: 16
                };
                
                worldGenerator.setWorldConfig(worldConfig);
                log('世界生成器初始化完成');
                
                // 生成多个区块测试
                const testChunks = [];
                log('开始生成测试区块 (0-4)...');
                
                for (let i = 0; i < 5; i++) {
                    const chunkData = worldGenerator.generateChunk(i);
                    testChunks.push(chunkData);
                    log(`区块 ${i} 生成完成，耗时: ${chunkData.metadata.generationTime.toFixed(2)}ms`);
                }
                
                // 收集统计信息
                testResults.chunkCount = testChunks.length;
                testResults.avgGenerationTime = testChunks.reduce((sum, chunk) => sum + chunk.metadata.generationTime, 0) / testChunks.length;
                
                // 验证地形高度变化
                log('验证地形高度变化...');
                testResults.terrainStats = verifyTerrainHeight(testChunks);
                
                // 验证方块多样性
                log('验证方块多样性...');
                testResults.blockStats = verifyBlockDiversity(testChunks);
                
                // 验证植被生成
                log('验证植被生成...');
                testResults.vegetationStats = verifyVegetation(testChunks);
                
                // 验证生物群系分布
                log('验证生物群系分布...');
                testResults.biomeStats = verifyBiomes(testChunks);
                
                const endTime = performance.now();
                testResults.testTime = endTime - startTime;
                
                log('✅ 地形生成测试完成!');
                updateStats();
                
            } catch (error) {
                log(`❌ 地形生成测试失败: ${error.message}`);
                console.error(error);
            }
        }
        
        // 验证地形高度变化
        function verifyTerrainHeight(chunks) {
            let minHeight = Infinity;
            let maxHeight = -Infinity;
            let totalHeight = 0;
            let sampleCount = 0;
            
            chunks.forEach(chunkData => {
                const chunk = chunkData.chunk;
                const surfaceMap = [];
                
                // 计算地表高度
                for (let x = 0; x < chunk[0].length; x++) {
                    for (let y = chunk.length - 1; y >= 0; y--) {
                        if (chunk[y][x] !== blockConfig.getBlock('air').id) {
                            surfaceMap[x] = y;
                            break;
                        }
                    }
                }
                
                // 统计高度信息
                surfaceMap.forEach(height => {
                    if (height !== undefined) {
                        minHeight = Math.min(minHeight, height);
                        maxHeight = Math.max(maxHeight, height);
                        totalHeight += height;
                        sampleCount++;
                    }
                });
            });
            
            const avgHeight = totalHeight / sampleCount;
            const heightRange = maxHeight - minHeight;
            
            log(`  最小高度: ${minHeight}`);
            log(`  最大高度: ${maxHeight}`);
            log(`  平均高度: ${avgHeight.toFixed(1)}`);
            log(`  高度范围: ${heightRange}`);
            
            // 评估地形变化
            if (heightRange > 100) {
                log('  ✅ 地形变化丰富');
            } else if (heightRange > 50) {
                log('  ⚠️ 地形变化一般');
            } else {
                log('  ❌ 地形过于平坦');
            }
            
            return {
                minHeight,
                maxHeight,
                avgHeight,
                heightRange
            };
        }
        
        // 验证方块多样性
        function verifyBlockDiversity(chunks) {
            const blockCounts = {};
            let totalBlocks = 0;
            
            chunks.forEach(chunkData => {
                const chunk = chunkData.chunk;
                
                for (let y = 0; y < chunk.length; y++) {
                    for (let x = 0; x < chunk[0].length; x++) {
                        const blockId = chunk[y][x];
                        if (!blockCounts[blockId]) {
                            blockCounts[blockId] = 0;
                        }
                        blockCounts[blockId]++;
                        totalBlocks++;
                    }
                }
            });
            
            log(`  总方块数: ${totalBlocks}`);
            log(`  不同方块类型数: ${Object.keys(blockCounts).length}`);
            
            // 找到最常见的方块
            let mostCommonBlock = '';
            let maxCount = 0;
            Object.entries(blockCounts).forEach(([blockId, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    const block = blockConfig.getBlock(parseInt(blockId));
                    mostCommonBlock = block ? block.name : `未知方块(${blockId})`;
                }
            });
            
            log(`  最常见方块: ${mostCommonBlock} (${maxCount} 个)`);
            
            // 评估多样性
            const diversity = Object.keys(blockCounts).length;
            if (diversity > 10) {
                log('  ✅ 方块多样性良好');
            } else if (diversity > 5) {
                log('  ⚠️ 方块多样性一般');
            } else {
                log('  ❌ 方块过于单一');
            }
            
            return {
                totalBlocks,
                blockTypes: diversity,
                mostCommonBlock
            };
        }
        
        // 验证植被生成
        function verifyVegetation(chunks) {
            let vegetationCount = 0;
            let treeCount = 0;
            let grassCount = 0;
            let flowerCount = 0;
            let totalBlocks = 0;
            
            const grassId = blockConfig.getBlock('grass').id;
            const leavesId = blockConfig.getBlock('leaves').id;
            const flowerId = blockConfig.getBlock('flower').id;
            const tallGrassId = blockConfig.getBlock('tallgrass').id;
            
            chunks.forEach(chunkData => {
                const chunk = chunkData.chunk;
                
                for (let y = 0; y < chunk.length; y++) {
                    for (let x = 0; x < chunk[0].length; x++) {
                        const blockId = chunk[y][x];
                        totalBlocks++;
                        
                        if (blockId === leavesId) {
                            treeCount++;
                            vegetationCount++;
                        } else if (blockId === grassId || blockId === tallGrassId) {
                            grassCount++;
                            vegetationCount++;
                        } else if (blockId === flowerId) {
                            flowerCount++;
                            vegetationCount++;
                        }
                    }
                }
            });
            
            log(`  植被总数: ${vegetationCount}`);
            log(`  树木: ${treeCount}`);
            log(`  草: ${grassCount}`);
            log(`  花朵: ${flowerCount}`);
            
            const vegetationPercentage = ((vegetationCount / totalBlocks) * 100);
            log(`  植被覆盖率: ${vegetationPercentage.toFixed(2)}%`);
            
            // 评估植被生成
            if (vegetationPercentage > 2) {
                log('  ✅ 植被生成良好');
            } else if (vegetationPercentage > 0.5) {
                log('  ⚠️ 植被生成一般');
            } else {
                log('  ❌ 植被生成不足');
            }
            
            return {
                total: vegetationCount,
                trees: treeCount,
                grass: grassCount,
                flowers: flowerCount,
                coverage: vegetationPercentage
            };
        }
        
        // 验证生物群系分布
        function verifyBiomes(chunks) {
            const biomeCounts = {};
            let totalColumns = 0;
            
            chunks.forEach(chunkData => {
                const biomeMap = chunkData.biomeMap;
                
                biomeMap.forEach(biome => {
                    if (!biomeCounts[biome]) {
                        biomeCounts[biome] = 0;
                    }
                    biomeCounts[biome]++;
                    totalColumns++;
                });
            });
            
            log(`  总列数: ${totalColumns}`);
            log(`  不同生物群系数: ${Object.keys(biomeCounts).length}`);
            
            // 找到最常见的生物群系
            let mostCommonBiome = '';
            let maxCount = 0;
            Object.entries(biomeCounts).forEach(([biome, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    mostCommonBiome = biome;
                }
            });
            
            log(`  最常见生物群系: ${mostCommonBiome} (${maxCount} 列)`);
            
            // 显示生物群系分布
            Object.entries(biomeCounts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([biome, count]) => {
                    const percentage = ((count / totalColumns) * 100).toFixed(1);
                    log(`    ${biome}: ${count} (${percentage}%)`);
                });
                
            // 评估生物群系多样性
            const diversity = Object.keys(biomeCounts).length;
            if (diversity > 4) {
                log('  ✅ 生物群系多样性良好');
            } else if (diversity > 2) {
                log('  ⚠️ 生物群系多样性一般');
            } else {
                log('  ❌ 生物群系过于单一');
            }
            
            return {
                biomeCount: diversity,
                mostCommonBiome,
                distribution: biomeCounts
            };
        }
        
        // 生成可视化测试
        function generateVisualTest() {
            if (!worldGenerator) {
                log('请先运行地形测试以初始化生成器');
                return;
            }
            
            const canvas = document.getElementById('terrainCanvas');
            const ctx = canvas.getContext('2d');
            
            // 清空画布
            ctx.fillStyle = '#87CEEB'; // 天空蓝
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 生成一个长区块用于可视化
            const chunkWidth = 200;
            const worldHeight = 400;
            const blockSize = 2; // 缩小显示
            
            log('生成可视化地形...');
            
            // 生成地形数据
            const terrainData = [];
            const biomeMap = [];
            
            for (let x = 0; x < chunkWidth; x++) {
                const worldX = x;
                const biome = worldGenerator.biomeGenerator.generateBiome(worldX, 0);
                biomeMap.push(biome);
                
                const height = worldGenerator.terrainGenerator.generateHeight(worldX, biome);
                terrainData.push(height);
            }
            
            // 绘制地形
            for (let x = 0; x < chunkWidth; x++) {
                const height = terrainData[x];
                const biome = biomeMap[x];
                
                // 计算绘制位置
                const screenX = x * blockSize;
                const screenY = canvas.height - (height * (canvas.height / worldHeight));
                const screenHeight = height * (canvas.height / worldHeight);
                
                // 根据生物群系设置颜色
                let color = '#8B4513'; // 默认棕色
                switch (biome) {
                    case 'ocean':
                        color = '#1E90FF'; // 蓝色
                        break;
                    case 'plains':
                        color = '#7CBB3A'; // 绿色
                        break;
                    case 'forest':
                        color = '#228B22'; // 深绿色
                        break;
                    case 'desert':
                        color = '#F4A460'; // 沙色
                        break;
                    case 'mountains':
                        color = '#696969'; // 灰色
                        break;
                    case 'swamp':
                        color = '#2F4F2F'; // 深绿色
                        break;
                    case 'tundra':
                        color = '#E0E0E0'; // 浅灰色
                        break;
                }
                
                // 绘制地形列
                ctx.fillStyle = color;
                ctx.fillRect(screenX, screenY, blockSize, screenHeight);
                
                // 绘制地表
                ctx.fillStyle = '#7CBB3A'; // 草绿色
                ctx.fillRect(screenX, screenY, blockSize, blockSize);
            }
            
            log('✅ 可视化地形生成完成');
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            log('Minecraft2D 地形测试工具已加载');
        });
    </script>
</body>
</html>