<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V键放置方块功能详细测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            margin-top: 10px;
        }
        .log-entry {
            margin: 5px 0;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .info {
            color: #2196F3;
        }
        .warning {
            color: #FF9800;
        }
        .debug {
            color: #9C27B0;
        }
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-on {
            background-color: #4CAF50;
        }
        .status-off {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>V键放置方块功能详细测试</h1>
        
        <div class="test-section">
            <h2>测试控制面板</h2>
            <div class="control-panel">
                <button class="test-button" onclick="runVKeyPressTest()">模拟V键按下</button>
                <button class="test-button" onclick="checkPlayerState()">检查玩家状态</button>
                <button class="test-button" onclick="checkHeldItem()">检查手持物品</button>
                <button class="test-button" onclick="testPlacementLogic()">测试放置逻辑</button>
                <button class="test-button" onclick="clearLogs()">清空日志</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>玩家状态监控</h2>
            <div id="player-status">
                <p>游戏引擎状态: <span id="engine-status">未初始化</span></p>
                <p>玩家系统状态: <span id="player-status">未初始化</span></p>
                <p>V键按下状态: <span id="vkey-status">未按下</span></p>
                <p>放置控制状态: <span id="place-status">未激活</span></p>
                <p>手持物品: <span id="held-item">无</span></p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>测试日志</h2>
            <div class="log" id="test-log">
                <div class="log-entry info">等待测试开始...</div>
            </div>
        </div>
    </div>

    <script>
        // 日志记录函数
        function logToTest(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // 更新状态显示
        function updateStatusDisplays() {
            // 更新游戏引擎状态
            const engineStatus = document.getElementById('engine-status');
            if (typeof window.gameEngine !== 'undefined' && window.gameEngine) {
                engineStatus.innerHTML = '<span class="status-indicator status-on"></span>已初始化';
            } else {
                engineStatus.innerHTML = '<span class="status-indicator status-off"></span>未初始化';
            }
            
            // 更新玩家系统状态
            const playerStatus = document.getElementById('player-status');
            if (typeof window.gameEngine !== 'undefined' && 
                window.gameEngine && 
                window.gameEngine.systems && 
                window.gameEngine.systems.player) {
                playerStatus.innerHTML = '<span class="status-indicator status-on"></span>已初始化';
            } else {
                playerStatus.innerHTML = '<span class="status-indicator status-off"></span>未初始化';
            }
            
            // 更新V键状态
            const vkeyStatus = document.getElementById('vkey-status');
            if (typeof window.inputManager !== 'undefined' && window.inputManager) {
                const isVPressed = window.inputManager.isKeyPressed('KeyV');
                vkeyStatus.innerHTML = isVPressed ? 
                    '<span class="status-indicator status-on"></span>已按下' : 
                    '<span class="status-indicator status-off"></span>未按下';
            } else {
                vkeyStatus.innerHTML = '<span class="status-indicator status-off"></span>未知';
            }
            
            // 更新放置控制状态
            const placeStatus = document.getElementById('place-status');
            if (typeof window.gameEngine !== 'undefined' && 
                window.gameEngine && 
                window.gameEngine.systems && 
                window.gameEngine.systems.player) {
                const player = window.gameEngine.systems.player;
                placeStatus.innerHTML = player.controls.place ? 
                    '<span class="status-indicator status-on"></span>已激活' : 
                    '<span class="status-indicator status-off"></span>未激活';
            } else {
                placeStatus.innerHTML = '<span class="status-indicator status-off"></span>未知';
            }
            
            // 更新手持物品
            const heldItem = document.getElementById('held-item');
            if (typeof window.gameEngine !== 'undefined' && 
                window.gameEngine && 
                window.gameEngine.systems && 
                window.gameEngine.systems.player) {
                const player = window.gameEngine.systems.player;
                const item = player.getHeldItem();
                if (item && !item.isEmpty()) {
                    const itemDef = item.getItemDefinition();
                    heldItem.textContent = itemDef ? itemDef.name : '未知物品';
                } else {
                    heldItem.textContent = '无';
                }
            } else {
                heldItem.textContent = '未知';
            }
        }
        
        // 模拟V键按下测试
        function runVKeyPressTest() {
            logToTest('开始模拟V键按下测试', 'info');
            
            try {
                // 创建并派发V键按下事件
                const keydownEvent = new KeyboardEvent('keydown', {
                    code: 'KeyV',
                    key: 'v',
                    bubbles: true
                });
                
                document.dispatchEvent(keydownEvent);
                logToTest('✓ 成功派发V键按下事件', 'success');
                
                // 等待一小段时间后检查状态
                setTimeout(() => {
                    updateStatusDisplays();
                    
                    // 检查放置控制状态
                    if (typeof window.gameEngine !== 'undefined' && 
                        window.gameEngine && 
                        window.gameEngine.systems && 
                        window.gameEngine.systems.player) {
                        const player = window.gameEngine.systems.player;
                        if (player.controls.place) {
                            logToTest('✓ 放置控制状态已激活', 'success');
                        } else {
                            logToTest('⚠ 放置控制状态未激活', 'warning');
                        }
                    }
                }, 100);
                
                // 创建并派发V键释放事件
                setTimeout(() => {
                    const keyupEvent = new KeyboardEvent('keyup', {
                        code: 'KeyV',
                        key: 'v',
                        bubbles: true
                    });
                    
                    document.dispatchEvent(keyupEvent);
                    logToTest('✓ 成功派发V键释放事件', 'success');
                    
                    // 再次检查状态
                    setTimeout(() => {
                        updateStatusDisplays();
                    }, 100);
                }, 500);
                
            } catch (error) {
                logToTest(`✗ 测试失败: ${error.message}`, 'error');
            }
        }
        
        // 检查玩家状态
        function checkPlayerState() {
            logToTest('检查玩家状态...', 'info');
            
            try {
                if (typeof window.gameEngine !== 'undefined' && window.gameEngine) {
                    logToTest('✓ 游戏引擎存在', 'success');
                    
                    if (window.gameEngine.systems && window.gameEngine.systems.player) {
                        const player = window.gameEngine.systems.player;
                        logToTest(`✓ 玩家系统存在`, 'success');
                        logToTest(`  控制状态:`, 'debug');
                        logToTest(`    place: ${player.controls.place}`, 'debug');
                        logToTest(`    mine: ${player.controls.mine}`, 'debug');
                        logToTest(`    jump: ${player.controls.jump}`, 'debug');
                        
                        logToTest(`  放置系统:`, 'debug');
                        logToTest(`    lastPlaceTime: ${player.placement.lastPlaceTime}`, 'debug');
                        logToTest(`    placeCooldown: ${player.placement.placeCooldown}`, 'debug');
                        
                        // 检查子模块
                        logToTest(`  子模块:`, 'debug');
                        logToTest(`    placementModule: ${!!player.placementModule}`, 'debug');
                        if (player.placementModule) {
                            logToTest(`    placementModule.handleBlockPlacement: ${typeof player.placementModule.handleBlockPlacement}`, 'debug');
                        }
                    } else {
                        logToTest('✗ 玩家系统不存在', 'error');
                    }
                } else {
                    logToTest('✗ 游戏引擎不存在', 'error');
                }
            } catch (error) {
                logToTest(`✗ 检查失败: ${error.message}`, 'error');
            }
            
            updateStatusDisplays();
        }
        
        // 检查手持物品
        function checkHeldItem() {
            logToTest('检查手持物品...', 'info');
            
            try {
                if (typeof window.gameEngine !== 'undefined' && 
                    window.gameEngine && 
                    window.gameEngine.systems && 
                    window.gameEngine.systems.player) {
                    
                    const player = window.gameEngine.systems.player;
                    const heldItem = player.getHeldItem();
                    
                    if (heldItem && !heldItem.isEmpty()) {
                        const itemDef = heldItem.getItemDefinition();
                        logToTest(`✓ 玩家手持物品: ${itemDef ? itemDef.name : '未知'}`, 'success');
                        
                        if (itemDef) {
                            logToTest(`  物品类型: ${itemDef.type}`, 'debug');
                            if (itemDef.type === 'block') {
                                logToTest(`  方块ID: ${itemDef.blockId}`, 'debug');
                            }
                        }
                    } else {
                        logToTest('⚠ 玩家手中没有物品', 'warning');
                    }
                } else {
                    logToTest('✗ 无法访问玩家系统', 'error');
                }
            } catch (error) {
                logToTest(`✗ 检查失败: ${error.message}`, 'error');
            }
            
            updateStatusDisplays();
        }
        
        // 测试放置逻辑
        function testPlacementLogic() {
            logToTest('测试放置逻辑...', 'info');
            
            try {
                if (typeof window.gameEngine !== 'undefined' && 
                    window.gameEngine && 
                    window.gameEngine.systems && 
                    window.gameEngine.systems.player) {
                    
                    const player = window.gameEngine.systems.player;
                    
                    // 检查是否有放置模块
                    if (player.placementModule) {
                        logToTest('✓ 放置模块存在', 'success');
                        
                        // 尝试调用测试方法（如果存在）
                        if (typeof player.testBlockPlacement === 'function') {
                            logToTest('调用玩家.testBlockPlacement()方法...', 'info');
                            const result = player.testBlockPlacement();
                            logToTest(`测试结果: ${result ? '成功' : '失败'}`, result ? 'success' : 'error');
                        } else if (typeof player.placementModule.testBlockPlacement === 'function') {
                            logToTest('调用placementModule.testBlockPlacement()方法...', 'info');
                            const result = player.placementModule.testBlockPlacement();
                            logToTest(`测试结果: ${result ? '成功' : '失败'}`, result ? 'success' : 'error');
                        } else {
                            logToTest('⚠ 未找到测试方法', 'warning');
                            
                            // 手动检查放置逻辑
                            logToTest('手动检查放置逻辑...', 'info');
                            
                            // 检查玩家是否持有方块
                            const heldItem = player.getHeldItem();
                            if (heldItem && !heldItem.isEmpty()) {
                                const itemDef = heldItem.getItemDefinition();
                                if (itemDef && itemDef.type === 'block') {
                                    logToTest('✓ 玩家持有方块物品', 'success');
                                    
                                    // 检查放置位置计算
                                    const placementPos = player.placementModule.getPlacementPosition();
                                    if (placementPos) {
                                        logToTest(`✓ 计算到放置位置: (${placementPos.x}, ${placementPos.y})`, 'success');
                                        
                                        // 检查位置合法性
                                        const isValid = player.placementModule.isPlacementPositionValid(placementPos);
                                        logToTest(`放置位置合法性: ${isValid ? '合法' : '非法'}`, isValid ? 'success' : 'error');
                                    } else {
                                        logToTest('✗ 无法计算放置位置', 'error');
                                    }
                                } else {
                                    logToTest('✗ 玩家手持物品不是方块类型', 'error');
                                }
                            } else {
                                logToTest('✗ 玩家手中没有物品', 'error');
                            }
                        }
                    } else {
                        logToTest('✗ 放置模块不存在', 'error');
                    }
                } else {
                    logToTest('✗ 无法访问玩家系统', 'error');
                }
            } catch (error) {
                logToTest(`✗ 测试失败: ${error.message}`, 'error');
            }
            
            updateStatusDisplays();
        }
        
        // 清空日志
        function clearLogs() {
            const logElement = document.getElementById('test-log');
            logElement.innerHTML = '<div class="log-entry info">日志已清空</div>';
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            logToTest('测试页面已加载', 'success');
            logToTest('开始监控玩家状态...', 'info');
            
            // 定期更新状态显示
            setInterval(updateStatusDisplays, 1000);
            
            // 初始状态更新
            updateStatusDisplays();
        });
        
        // 监听实际的键盘事件
        document.addEventListener('keydown', function(event) {
            if (event.code === 'KeyV') {
                logToTest('检测到实际V键按下事件', 'info');
                setTimeout(updateStatusDisplays, 50);
            }
        });
        
        document.addEventListener('keyup', function(event) {
            if (event.code === 'KeyV') {
                logToTest('检测到实际V键释放事件', 'info');
                setTimeout(updateStatusDisplays, 50);
            }
        });
    </script>
</body>
</html>